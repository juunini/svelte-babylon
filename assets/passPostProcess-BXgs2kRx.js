const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dumpTools-CZbuZi2T.js","./iframe-vcUCgR62.js","./create-runtime-stories-BWJ8FmbH.js","./props-D_CwaEcb.js","./index-client-a4XWVA08.js","./index-D-8MO0q_.js","./index-BHYIh-Xd.js","./_commonjsHelpers-Cpj98o6Y.js","./postprocess.vertex-BCogYBnC.js","./pass.fragment-QkkmHVv7.js","./pass.fragment-BRG0OkV1.js"])))=>i.map(i=>d[i]);
import{a4 as se,S as re,V as b,g as ie,C as F,a5 as U,a6 as ne,a7 as x,a8 as ae,a9 as W,u as L,i as oe,q as he,aa as de,ab as le,ac as ue,a as fe,ad as ce,ae as _e,e as N,s as H,af as O,ag as S,ah as pe,y as Z,ai as X,c as $,aj as K,Z as G,ak as ge}from"./create-runtime-stories-BWJ8FmbH.js";import{_ as I}from"./iframe-vcUCgR62.js";class B{constructor(e,t,s,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=s,this.worldAxisForFileY=r}}class Y{static ConvertCubeMapTextureToSphericalPolynomial(e){var u;if(!e.isCube)return null;(u=e.getScene())==null||u.getEngine().flushFramebuffer();const t=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let i,a;e.isRenderTarget?(i=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(i=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const o=e.readPixels(4,void 0,void 0,!1),h=e.readPixels(5,void 0,void 0,!1),n=e.gammaSpace,d=5;let f=0;return(e.textureType==1||e.textureType==2)&&(f=1),new Promise(c=>{Promise.all([r,s,i,a,o,h]).then(([v,m,p,E,P,T])=>{const C={size:t,right:m,left:v,up:p,down:E,front:P,back:T,format:d,type:f,gammaSpace:n};c(this.ConvertCubeMapToSphericalPolynomial(C))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new se;let s=0;const r=2/e.size,i=r,a=.5*r,o=a-1;for(let u=0;u<6;u++){const c=this._FileFaces[u],v=e[c.name];let m=o;const p=e.format===5?4:3;for(let E=0;E<e.size;E++){let P=o;for(let T=0;T<e.size;T++){const C=c.worldAxisForFileX.scale(P).add(c.worldAxisForFileY.scale(m)).add(c.worldAxisForNormal);C.normalize();const _=this._AreaElement(P-a,m-a)-this._AreaElement(P-a,m+a)-this._AreaElement(P+a,m-a)+this._AreaElement(P+a,m+a);let l=v[E*e.size*p+T*p+0],A=v[E*e.size*p+T*p+1],w=v[E*e.size*p+T*p+2];isNaN(l)&&(l=0),isNaN(A)&&(A=0),isNaN(w)&&(w=0),e.type===0&&(l/=255,A/=255,w/=255),e.gammaSpace&&(l=Math.pow(F(l),U),A=Math.pow(F(A),U),w=Math.pow(F(w),U));const D=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const q=Math.max(l,A,w);if(q>D){const V=D/q;l*=V,A*=V,w*=V}}else l=F(l,0,D),A=F(A,0,D),w=F(w,0,D);const te=new ie(l,A,w);t.addLight(C,te,_),s+=_,P+=r}m+=i}}const f=4*Math.PI*6/6/s;return t.scaleInPlace(f),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),re.FromHarmonics(t)}}Y._FileFaces=[new B("right",new b(1,0,0),new b(0,0,-1),new b(0,-1,0)),new B("left",new b(-1,0,0),new b(0,0,1),new b(0,-1,0)),new B("up",new b(0,1,0),new b(1,0,0),new b(0,0,1)),new B("down",new b(0,-1,0),new b(1,0,0),new b(0,0,-1)),new B("front",new b(0,0,1),new b(1,0,0),new b(0,-1,0)),new B("back",new b(0,0,-1),new b(-1,0,0),new b(0,-1,0))];Y.MAX_HDRI_VALUE=4096;Y.PRESERVE_CLAMPED_COLORS=!1;class y{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=ne(e,this._renderListHasChanged)),this._renderList=e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let s;Array.isArray(e)?s=e:s=[e];for(let r=0;r<s.length;++r)for(let i=0;i<this.options.numPasses;++i)s[r].setMaterialForRenderPass(this._renderPassIds[i],t!==void 0?Array.isArray(t)?t[i]:t:void 0)}constructor(e,t,s){this._unObserveRenderList=null,this._renderListHasChanged=(r,i)=>{const a=this._renderList?this._renderList.length:0;(i===0&&a>0||a===0)&&this._scene.meshes.forEach(o=>{o._markSubMeshesAsLightDirty()})},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.onBeforeRenderObservable=new x,this.onAfterRenderObservable=new x,this.onBeforeRenderingManagerRenderObservable=new x,this.onAfterRenderingManagerRenderObservable=new x,this.onFastPathRenderObservable=new x,this._currentRefreshId=-1,this._refreshRate=1,this._currentSceneCamera=null,this.name=e,this._scene=t,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...s},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new ae(t),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)this._renderPassIds[t]=e.createRenderPassId(`ObjectRenderer - ${this.name}#${t}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);const s=this._checkReadiness();return this.finishRender(),s}prepareRenderList(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const s=this._waitingRenderList[t],r=e.getMeshById(s);r&&this.renderList.push(r)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const t=this._scene.meshes;for(let s=0;s<t.length;s++){const r=t[s];this.renderListPredicate(r)&&this.renderList.push(r)}}}initRender(e,t){const s=this._scene.getEngine(),r=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,r&&(r!==this._scene.activeCamera&&(this._scene.setTransformMatrix(r.getViewMatrix(),r.getProjectionMatrix(!0)),this._scene.activeCamera=r),s.setViewport(r.rigParent?r.rigParent.viewport:r.viewport,e,t)),this._defaultRenderListPrepared=!1}finishRender(){const e=this._scene;e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),e.getEngine().setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial()}render(e=0,t=!1){const s=this._scene,r=s.getEngine(),i=r.currentRenderPassId;if(r.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e),r.snapshotRendering&&r.snapshotRenderingMode===1)this.onFastPathRenderObservable.notifyObservers(e);else{let o=null;const h=this.renderList?this.renderList:s.getActiveMeshes().data,n=this.renderList?this.renderList.length:s.getActiveMeshes().length;this.getCustomRenderList&&(o=this.getCustomRenderList(e,h,n)),o?this._prepareRenderingManager(o,o.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(h,n,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),o=h),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,o,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e)}t||this.onAfterRenderObservable.notifyObservers(e),r.currentRenderPassId=i}_checkReadiness(){const e=this._scene,t=e.getEngine(),s=t.currentRenderPassId;let r=!0;e.getViewMatrix()||e.updateTransformMatrix();const i=this.options.numPasses;for(let o=0;o<i&&r;o++){let h=null;const n=this.renderList?this.renderList:e.getActiveMeshes().data,d=this.renderList?this.renderList.length:e.getActiveMeshes().length;t.currentRenderPassId=this._renderPassIds[o],this.onBeforeRenderObservable.notifyObservers(o),this.getCustomRenderList&&(h=this.getCustomRenderList(o,n,d)),h||(h=n),this._doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let f=0;f<h.length&&r;++f){const u=h[f];if(!(!u.isEnabled()||u.isBlocked||!u.isVisible||!u.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(u,this.refreshRate,!0)){r=!1;continue}}else if(!u.isReady(!0)){r=!1;continue}}}this.onAfterRenderObservable.notifyObservers(o),i>1&&(e.incrementRenderId(),e.resetCachedMaterial())}const a=this.particleSystemList||e.particleSystems;for(const o of a)o.isReady()||(r=!1);return t.currentRenderPassId=s,r}_prepareRenderingManager(e,t,s){const r=this._scene,i=r.activeCamera;this._renderingManager.reset();const a=r.getRenderId();for(let h=0;h<t;h++){const n=e[h];if(n&&!n.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(n,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!n.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!n._internalAbstractMeshDataInfo._currentLODIsUpToDate&&i&&(n._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(n,i):n.getLOD(i),n._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!n._internalAbstractMeshDataInfo._currentLOD)continue;let d=n._internalAbstractMeshDataInfo._currentLOD;d!==n&&d.billboardMode!==0&&d.computeWorldMatrix(),d._preActivateForIntermediateRendering(a);let f;if(s&&i?f=(n.layerMask&i.layerMask)===0:f=!1,n.isEnabled()&&n.isVisible&&n.subMeshes&&!f){if(d!==n&&d._activate(a,!0),n._activate(a,!0)&&n.subMeshes.length){n.isAnInstance?n._internalAbstractMeshDataInfo._actAsRegularMesh&&(d=n):d._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,d._internalAbstractMeshDataInfo._isActiveIntermediate=!0,r._prepareSkeleton(d);for(let u=0;u<d.subMeshes.length;u++){const c=d.subMeshes[u];this._renderingManager.dispatch(c,d)}}n._postActivate()}}}const o=this.particleSystemList||r.particleSystems;for(let h=0;h<o.length;h++){const n=o[h],d=n.emitter;!n.isStarted()||!d||d.position&&!d.isEnabled()||this._renderingManager.dispatchParticles(n)}}setRenderingOrder(e,t=null,s=null,r=null){this._renderingManager.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=new y(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let s=0;s<t;s++){const r=e[s];r.getMaterialForRenderPass(this.renderPassId)!==void 0&&r.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===y.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=y.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}y.REFRESHRATE_RENDER_ONCE=0;y.REFRESHRATE_RENDER_ONEVERYFRAME=1;y.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;W.prototype.setDepthStencilTexture=function(R,e){this._engine.setDepthStencilTexture(this._samplers[R],this._uniforms[R],e,R)};class z extends L{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){var e;return((e=this._renderTarget)==null?void 0:e.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e;return((e=this._renderTarget)==null?void 0:e._depthStencilTexture)??null}constructor(e,t,s,r=!1,i=!0,a=0,o=!1,h=L.TRILINEAR_SAMPLINGMODE,n=!0,d=!1,f=!1,u=5,c=!1,v,m,p=!1,E=!1){let P,T=!0;if(typeof r=="object"){const _=r;r=!!_.generateMipMaps,i=_.doNotChangeAspectRatio??!0,a=_.type??0,o=!!_.isCube,h=_.samplingMode??L.TRILINEAR_SAMPLINGMODE,n=_.generateDepthBuffer??!0,d=!!_.generateStencilBuffer,f=!!_.isMulti,u=_.format??5,c=!!_.delayAllocation,v=_.samples,m=_.creationFlags,p=!!_.noColorAttachment,E=!!_.useSRGBBuffer,P=_.colorAttachment,T=_.gammaSpace??T}if(super(null,s,!r,void 0,h,void 0,void 0,void 0,void 0,u),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new x,this.onAfterUnbindObservable=new x,this.onClearObservable=new x,this.onResizeObservable=new x,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=b.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,s=this.getScene(),!s)return;const C=this.getScene().getEngine();this._gammaSpace=T,this._coordinatesMode=L.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._processSizeParameter(t),this._objectRenderer=new y(e,s,{numPasses:o?6:this.getRenderLayers()||1,doNotChangeAspectRatio:i}),this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const _ of this._scene._beforeRenderTargetClearStage)_.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(C):this.skipInitialClear||C.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const _ of this._scene._beforeRenderTargetDrawStage)_.action(this,this._currentFaceIndex,this._currentLayer)}),this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{var l;if(!this._disableEngineStages)for(const A of this._scene._afterRenderTargetDrawStage)A.action(this,this._currentFaceIndex,this._currentLayer);const _=((l=this._texture)==null?void 0:l.generateMipMaps)??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const A of this._scene._afterRenderTargetPostProcessStage)A.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=_),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),C):oe.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(C):this.skipInitialClear||C.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=C.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=i,!f&&(this._renderTargetOptions={generateMipMaps:r,type:a,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:n,generateStencilBuffer:d,samples:v,creationFlags:m,noColorAttachment:p,useSRGBBuffer:E,colorAttachment:P,label:this.name},this.samplingMode===L.NEAREST_SAMPLINGMODE&&(this.wrapU=L.CLAMP_ADDRESSMODE,this.wrapV=L.CLAMP_ADDRESSMODE),c||(o?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=L.INVCUBIC_MODE,this._textureMatrix=he.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,v!==void 0&&(this.samples=v)))}createDepthStencilTexture(e=0,t=!0,s=!1,r=1,i=14,a){var o;(o=this._renderTarget)==null||o.createDepthStencilTexture(e,t,s,r,i,a)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){var e;return((e=this._renderTarget)==null?void 0:e.samples)??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new de(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;const t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var r;const t=this.isCube;(r=this._renderTarget)==null||r.dispose(),this._renderTarget=null;const s=this.getScene();s&&(this._processSizeParameter(e),t?this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,I(()=>import("./dumpTools-CZbuZi2T.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url).then(t=>this._dumpTools=t)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){const s=this.getScene();if(s){if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),(this.is2DArray||this.is3D)&&!this.isMulti)for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,e,t,r),s.incrementRenderId(),s.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,e,t),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,e,t);this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){const r=e*t,i=le(r+128*128/(128+r));return Math.min(ue(e),i)}_bindFrameBuffer(e=0,t=0){const s=this.getScene();if(!s)return;const r=s.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,s,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,s)}_renderToTarget(e,t,s,r=0){var o,h;const i=this.getScene();if(!i)return;const a=i.getEngine();this._currentFaceIndex=e,this._currentLayer=r,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=s,this._prepareFrame(i,e,r,t),(o=a._debugPushGroup)==null||o.call(a,`render to face #${e} layer #${r}`,2),this._objectRenderer.render(e+r,!0),(h=a._debugPopGroup)==null||h.call(a,2),this._unbindFrameBuffer(a,e),this._texture&&this.isCube&&e===5&&a.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,s=null,r=null){this._objectRenderer.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){const e=this.getSize(),t=new z(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)==null||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)==null||e.releaseTextures(),this._texture=null}dispose(){var s;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const r of e.cameras)t=r.customRenderTargets.indexOf(this),t>=0&&r.customRenderTargets.splice(t,1);(s=this._renderTarget)==null||s.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}z.REFRESHRATE_RENDER_ONCE=y.REFRESHRATE_RENDER_ONCE;z.REFRESHRATE_RENDER_ONEVERYFRAME=y.REFRESHRATE_RENDER_ONEVERYFRAME;z.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=y.REFRESHRATE_RENDER_ONEVERYTWOFRAMES;L._CreateRenderTargetTexture=(R,e,t,s,r)=>new z(R,e,t,s);const J="postprocessVertexShader",Q=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;fe.ShadersStore[J]=Q;const Re={name:J,shader:Q},ee=Object.freeze(Object.defineProperty({__proto__:null,postprocessVertexShader:Re},Symbol.toStringTag,{value:"Module"})),k={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class ve{constructor(e,t=k){this._fullscreenViewport=new _e(0,0,1,1);const s=t.positions??k.positions,r=t.indices??k.indices;this.engine=e,this._vertexBuffers={[N.PositionKind]:new N(e,s,N.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(r);for(const i in this._vertexBuffers)this._vertexBuffers[i]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const s=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;s&&this.engine.bindFramebuffer(s),this.applyEffectWrapper(e),this.draw(),s&&this.engine.unBindFramebuffer(s),this.restoreStates()}dispose(){const e=this._vertexBuffers[N.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[N.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class M{static RegisterShaderCodeProcessing(e,t){if(!t){delete M._CustomShaderCodeProcessing[e??""];return}M._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){return M._CustomShaderCodeProcessing[e]??M._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){var e;return((e=this._drawWrapper.effect)==null?void 0:e.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new x(void 0,!0),this.onApplyObservable=new x,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(this.options.samplers.indexOf("textureSampler")===-1&&this.options.samplers.push("textureSampler"),this.options.uniforms.indexOf("scale")===-1&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new ce(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;const t=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([I(()=>import("./postprocess.vertex-BCogYBnC.js"),__vite__mapDeps([8,2,3,4,1,5,6,7]),import.meta.url)])):t.push(Promise.all([I(()=>Promise.resolve().then(()=>ee),void 0,import.meta.url)])))}_postConstructor(e,t=null,s,r){this._importPromises.length=0,r&&this._importPromises.push(...r);const i=this.options.engine.isWebGPU&&!M.ForceGLSL;this._gatherImports(i,this._importPromises),s!==void 0&&s(i,this._importPromises),i&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,s=null,r,i,a,o,h){const n=M._GetShaderCodeProcessing(this.name);if(n!=null&&n.defineCustomBindings){const u=(t==null?void 0:t.slice())??[];u.push(...this.options.uniforms);const c=(s==null?void 0:s.slice())??[];c.push(...this.options.samplers),e=n.defineCustomBindings(this.name,e,u,c),t=u,s=c}this.options.defines=e||"";const d=this._shadersLoaded||this._importPromises.length===0?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let f;this.options.extraInitializationsAsync?f=async()=>{d==null||d(),await this.options.extraInitializationsAsync}:f=d,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:o??this._shaderPath.vertex,fragment:h??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:s||this.options.samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:i??this.options.onCompiled,onError:a??null,indexParameters:r||this.options.indexParameters,processCodeAfterIncludes:n!=null&&n.processCodeAfterIncludes?(u,c)=>n.processCodeAfterIncludes(this.name,u,c):null,processFinalCode:n!=null&&n.processFinalCode?(u,c)=>n.processFinalCode(this.name,u,c):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:f},this.options.engine):this._drawWrapper.effect=new W(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,s||this.options.samplerNames,this.options.engine,e,void 0,i||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,f),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var e,t;this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),(t=(e=M._GetShaderCodeProcessing(this.name))==null?void 0:e.bindCustomBindings)==null||t.call(e,this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}M.ForceGLSL=!1;M._CustomShaderCodeProcessing={};H.prototype.setTextureFromPostProcess=function(R,e,t){let s=null;e&&(e._forcedOutputTexture?s=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(s=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(R,(s==null?void 0:s.texture)??null,t)};H.prototype.setTextureFromPostProcessOutput=function(R,e,t){var s;this._bindTexture(R,((s=e==null?void 0:e._outputTexture)==null?void 0:s.texture)??null,t)};W.prototype.setTextureFromPostProcess=function(R,e){this._engine.setTextureFromPostProcess(this._samplers[R],e,R)};W.prototype.setTextureFromPostProcessOutput=function(R,e){this._engine.setTextureFromPostProcessOutput(this._samplers[R],e,R)};class g{static get ForceGLSL(){return M.ForceGLSL}static set ForceGLSL(e){M.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){M.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,s,r,i,a,o=1,h,n,d=null,f=0,u="postprocess",c,v=!1,m=5,p,E){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new X(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new $(1,1),this._texelSize=$.Zero(),this.onActivateObservable=new x,this.onSizeChangedObservable=new x,this.onApplyObservable=new x,this.onBeforeRenderObservable=new x,this.onAfterRenderObservable=new x;let P=1,T=null,C;if(s&&!Array.isArray(s)){const l=s;s=l.uniforms??null,r=l.samplers??null,P=l.size??1,a=l.camera??null,o=l.samplingMode??1,h=l.engine,n=l.reusable,d=Array.isArray(l.defines)?l.defines.join(`
`):l.defines??null,f=l.textureType??0,u=l.vertexUrl??"postprocess",c=l.indexParameters,v=l.blockCompilation??!1,m=l.textureFormat??5,p=l.shaderLanguage??0,T=l.uniformBuffers??null,E=l.extraInitializations,C=l.effectWrapper}else i&&(typeof i=="number"?P=i:P={width:i.width,height:i.height});const _=!!C;if(this._effectWrapper=C??new M({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:h||(a==null?void 0:a.getScene().getEngine()),uniforms:s,samplers:r,uniformBuffers:T,defines:d,vertexUrl:u,indexParameters:c,blockCompilation:!0,shaderLanguage:p,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,a!=null?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):h&&(this._engine=h,this._engine.postProcesses.push(this)),this._options=P,this.renderTargetSamplingMode=o||1,this._reusable=n||!1,this._textureType=f,this._textureFormat=m,this._shaderLanguage=p||0,this._samplers=r||[],this._samplers.indexOf("textureSampler")===-1&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=u,this._parameters=s||[],this._parameters.indexOf("scale")===-1&&this._parameters.push("scale"),this._uniformBuffers=T||[],this._indexParameters=c,!_){this._webGPUReady=this._shaderLanguage===1;const l=[];this._gatherImports(this._engine.isWebGPU&&!g.ForceGLSL,l),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(v,d,E,l)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([I(()=>import("./postprocess.vertex-BCogYBnC.js"),__vite__mapDeps([8,2,3,4,1,5,6,7]),import.meta.url)])):t.push(Promise.all([I(()=>Promise.resolve().then(()=>ee),void 0,import.meta.url)]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new X(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,s=null,r,i,a,o,h){this._effectWrapper.updateEffect(e,t,s,r,i,a,o,h),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join(`
`):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,s=0){for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture.width===e.width&&this._textureCache[i].texture.height===e.height&&this._textureCache[i].postProcessChannel===s&&this._textureCache[i].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[i].texture.samples===t.samples)return this._textureCache[i].texture;const r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:s,lastUsedRenderId:-1}),r}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let s=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){s=!0;break}s||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,s=null,r=!1,i=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let a=null;if(s){for(let n=0;n<s._postProcesses.length;n++)if(s._postProcesses[n]!==null){a=s._postProcesses[n];break}}const o={width:this.width,height:this.height},h={generateMipMaps:r,generateDepthBuffer:i||a===this,generateStencilBuffer:(i||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,h,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,h,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture===e){t=this._textureCache[s];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,s){var v,m;const r=e===null||e.cameraRigMode!==void 0?e||this._camera:null,i=(r==null?void 0:r.getScene())??e,a=i.getEngine(),o=a.getCaps().maxTextureSize,h=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,n=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let d=this._options.width||h,f=this._options.height||n;const u=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;let c=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const p=a.currentViewport;p&&(d*=p.width,f*=p.height)}(u||this.alwaysForcePOT)&&(this._options.width||(d=a.needPOTTextures?K(d,o,this.scaleMode):d),this._options.height||(f=a.needPOTTextures?K(f,o,this.scaleMode):f)),(this.width!==d||this.height!==f||!(c=this._getTarget()))&&this.resize(d,f,r,u,s),this._textures.forEach(p=>{p.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(p,this.samples)}),this._flushTextureCache(),this._renderId++}return c||(c=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(h/d,n/f),this._engine.bindFramebuffer(c,0,h,n,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(c,0,void 0,void 0,this.forceFullscreenViewport)),(m=(v=this._engine)._debugInsertMarker)==null||m.call(v,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(r),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:i.clearColor,i._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),c}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e==null?void 0:e.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const s=this._parentContainer.postProcesses.indexOf(this);s>-1&&this._parentContainer.postProcesses.splice(s,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const s=this._camera._getFirstPostProcess();s&&s.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=G.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=g.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,s){const r=ge(e.customType);if(!r||!r._Parse)return null;const i=t?t.getCameraById(e.cameraId):null;return r._Parse(e,i,t,s)}static _Parse(e,t,s,r){return G.Parse(()=>new g(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,s,r)}}O([S()],g.prototype,"uniqueId",void 0);O([S()],g.prototype,"name",null);O([S()],g.prototype,"width",void 0);O([S()],g.prototype,"height",void 0);O([S()],g.prototype,"renderTargetSamplingMode",void 0);O([pe()],g.prototype,"clearColor",void 0);O([S()],g.prototype,"autoClear",void 0);O([S()],g.prototype,"forceAutoClearInAlphaMode",void 0);O([S()],g.prototype,"alphaMode",null);O([S()],g.prototype,"alphaConstants",void 0);O([S()],g.prototype,"enablePixelPerfectMode",void 0);O([S()],g.prototype,"forceFullscreenViewport",void 0);O([S()],g.prototype,"scaleMode",void 0);O([S()],g.prototype,"alwaysForcePOT",void 0);O([S("samples")],g.prototype,"_samples",void 0);O([S()],g.prototype,"adaptScaleToCurrentViewport",void 0);Z("BABYLON.PostProcess",g);class j extends g{getClassName(){return"PassPostProcess"}constructor(e,t,s=null,r,i,a,o=0,h=!1){super(e,"pass",null,null,t,s,r,i,a,void 0,o,void 0,null,h)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([I(()=>import("./pass.fragment-QkkmHVv7.js"),__vite__mapDeps([9,2,3,4,1,5,6,7]),import.meta.url)]))):t.push(Promise.all([I(()=>import("./pass.fragment-BRG0OkV1.js"),__vite__mapDeps([10,2,3,4,1,5,6,7]),import.meta.url)])),super._gatherImports(e,t)}static _Parse(e,t,s,r){return G.Parse(()=>new j(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,s,r)}}Z("BABYLON.PassPostProcess",j);H._RescalePostProcessFactory=R=>new j("rescale",1,null,2,R,!1,0);export{Y as C,ve as E,g as P,M as a};
